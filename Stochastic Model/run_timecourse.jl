include("stoch_model.jl")

n = 10^4 + 1

ens_prob = EnsembleProblem(jump_prob)

@time sim = solve(ens_prob, FunctionMap(),
                  EnsembleThreads(),
                  saveat=0.01,
                  trajectories=n)

using DifferentialEquations.EnsembleAnalysis

u_mean = timeseries_steps_mean(sim).u
CSV.write("kinetics_means.csv", DataFrame(t = timeseries_steps_mean(sim).t,
                                     V_free_wt = [u[1] for u in u_mean],
                                     V_bound_wt =[u[2] for u in u_mean],
                                     V_endosome_wt =[u[3] for u in u_mean],
                                     gRNA_plus_wt =[u[4] for u in u_mean],
                                     V_free_dip = [u[5] for u in u_mean],
                                     V_bound_dip =[u[6] for u in u_mean],
                                     V_endosome_dip =[u[7] for u in u_mean],
                                     gRNA_plus_dip =[u[8] for u in u_mean],
                                     NSP =[u[9] for u in u_mean],
                                     gRNA_minus_wt =[u[10] for u in u_mean],
                                     gRNA_wt =[u[11] for u in u_mean],
                                     gRNA_minus_dip =[u[12] for u in u_mean],
                                     gRNA_dip =[u[13] for u in u_mean],
                                     N =[u[14] for u in u_mean],
                                     SP =[u[15] for u in u_mean],
                                     N_gRNA_wt =[u[16] for u in u_mean],
                                     N_gRNA_dip =[u[17] for u in u_mean],
                                     V_assembled_wt =[u[18] for u in u_mean],
                                     V_released_wt =[u[19] for u in u_mean],
                                     V_assembled_dip =[u[20] for u in u_mean],
                                     V_released_dip =[u[21] for u in u_mean]))

u_median = timeseries_steps_median(sim).u
CSV.write("kinetics_medians.csv", DataFrame(t = timeseries_steps_mean(sim).t,
                                     V_free_wt = [u[1] for u in u_median],
                                     V_bound_wt =[u[2] for u in u_median],
                                     V_endosome_wt =[u[3] for u in u_median],
                                     gRNA_plus_wt =[u[4] for u in u_median],
                                     V_free_dip = [u[5] for u in u_median],
                                     V_bound_dip =[u[6] for u in u_median],
                                     V_endosome_dip =[u[7] for u in u_median],
                                     gRNA_plus_dip =[u[8] for u in u_median],
                                     NSP =[u[9] for u in u_median],
                                     gRNA_minus_wt =[u[10] for u in u_median],
                                     gRNA_wt =[u[11] for u in u_median],
                                     gRNA_minus_dip =[u[12] for u in u_median],
                                     gRNA_dip =[u[13] for u in u_median],
                                     N =[u[14] for u in u_median],
                                     SP =[u[15] for u in u_median],
                                     N_gRNA_wt =[u[16] for u in u_median],
                                     N_gRNA_dip =[u[17] for u in u_median],
                                     V_assembled_wt =[u[18] for u in u_median],
                                     V_released_wt =[u[19] for u in u_median],
                                     V_assembled_dip =[u[20] for u in u_median],
                                     V_released_dip =[u[21] for u in u_median]))

u_q25 = timeseries_steps_quantile(sim, 0.25).u
CSV.write("kinetics_q25.csv", DataFrame(t = timeseries_steps_mean(sim).t,
                                     V_free_wt = [u[1] for u in u_q25],
                                     V_bound_wt =[u[2] for u in u_q25],
                                     V_endosome_wt =[u[3] for u in u_q25],
                                     gRNA_plus_wt =[u[4] for u in u_q25],
                                     V_free_dip = [u[5] for u in u_q25],
                                     V_bound_dip =[u[6] for u in u_q25],
                                     V_endosome_dip =[u[7] for u in u_q25],
                                     gRNA_plus_dip =[u[8] for u in u_q25],
                                     NSP =[u[9] for u in u_q25],
                                     gRNA_minus_wt =[u[10] for u in u_q25],
                                     gRNA_wt =[u[11] for u in u_q25],
                                     gRNA_minus_dip =[u[12] for u in u_q25],
                                     gRNA_dip =[u[13] for u in u_q25],
                                     N =[u[14] for u in u_q25],
                                     SP =[u[15] for u in u_q25],
                                     N_gRNA_wt =[u[16] for u in u_q25],
                                     N_gRNA_dip =[u[17] for u in u_q25],
                                     V_assembled_wt =[u[18] for u in u_q25],
                                     V_released_wt =[u[19] for u in u_q25],
                                     V_assembled_dip =[u[20] for u in u_q25],
                                     V_released_dip =[u[21] for u in u_q25]))

u_q75 = timeseries_steps_quantile(sim, 0.75).u
CSV.write("kinetics_q75.csv", DataFrame(t = timeseries_steps_mean(sim).t,
                                     V_free_wt = [u[1] for u in u_q75],
                                     V_bound_wt =[u[2] for u in u_q75],
                                     V_endosome_wt =[u[3] for u in u_q75],
                                     gRNA_plus_wt =[u[4] for u in u_q75],
                                     V_free_dip = [u[5] for u in u_q75],
                                     V_bound_dip =[u[6] for u in u_q75],
                                     V_endosome_dip =[u[7] for u in u_q75],
                                     gRNA_plus_dip =[u[8] for u in u_q75],
                                     NSP =[u[9] for u in u_q75],
                                     gRNA_minus_wt =[u[10] for u in u_q75],
                                     gRNA_wt =[u[11] for u in u_q75],
                                     gRNA_minus_dip =[u[12] for u in u_q75],
                                     gRNA_dip =[u[13] for u in u_q75],
                                     N =[u[14] for u in u_q75],
                                     SP =[u[15] for u in u_q75],
                                     N_gRNA_wt =[u[16] for u in u_q75],
                                     N_gRNA_dip =[u[17] for u in u_q75],
                                     V_assembled_wt =[u[18] for u in u_q75],
                                     V_released_wt =[u[19] for u in u_q75],
                                     V_assembled_dip =[u[20] for u in u_q75],
                                     V_released_dip =[u[21] for u in u_q75]))

u_q5 = timeseries_steps_quantile(sim, 0.5).u
CSV.write("kinetics_q5.csv", DataFrame(t = timeseries_steps_mean(sim).t,
                                     V_free_wt = [u[1] for u in u_q5],
                                     V_bound_wt =[u[2] for u in u_q5],
                                     V_endosome_wt =[u[3] for u in u_q5],
                                     gRNA_plus_wt =[u[4] for u in u_q5],
                                     V_free_dip = [u[5] for u in u_q5],
                                     V_bound_dip =[u[6] for u in u_q5],
                                     V_endosome_dip =[u[7] for u in u_q5],
                                     gRNA_plus_dip =[u[8] for u in u_q5],
                                     NSP =[u[9] for u in u_q5],
                                     gRNA_minus_wt =[u[10] for u in u_q5],
                                     gRNA_wt =[u[11] for u in u_q5],
                                     gRNA_minus_dip =[u[12] for u in u_q5],
                                     gRNA_dip =[u[13] for u in u_q5],
                                     N =[u[14] for u in u_q5],
                                     SP =[u[15] for u in u_q5],
                                     N_gRNA_wt =[u[16] for u in u_q5],
                                     N_gRNA_dip =[u[17] for u in u_q5],
                                     V_assembled_wt =[u[18] for u in u_q5],
                                     V_released_wt =[u[19] for u in u_q5],
                                     V_assembled_dip =[u[20] for u in u_q5],
                                     V_released_dip =[u[21] for u in u_q5]))

u_q95 = timeseries_steps_quantile(sim, 0.95).u
CSV.write("kinetics_q95.csv", DataFrame(t = timeseries_steps_mean(sim).t,
                                     V_free_wt = [u[1] for u in u_q95],
                                     V_bound_wt =[u[2] for u in u_q95],
                                     V_endosome_wt =[u[3] for u in u_q95],
                                     gRNA_plus_wt =[u[4] for u in u_q95],
                                     V_free_dip = [u[5] for u in u_q95],
                                     V_bound_dip =[u[6] for u in u_q95],
                                     V_endosome_dip =[u[7] for u in u_q95],
                                     gRNA_plus_dip =[u[8] for u in u_q95],
                                     NSP =[u[9] for u in u_q95],
                                     gRNA_minus_wt =[u[10] for u in u_q95],
                                     gRNA_wt =[u[11] for u in u_q95],
                                     gRNA_minus_dip =[u[12] for u in u_q95],
                                     gRNA_dip =[u[13] for u in u_q95],
                                     N =[u[14] for u in u_q95],
                                     SP =[u[15] for u in u_q95],
                                     N_gRNA_wt =[u[16] for u in u_q95],
                                     N_gRNA_dip =[u[17] for u in u_q95],
                                     V_assembled_wt =[u[18] for u in u_q95],
                                     V_released_wt =[u[19] for u in u_q95],
                                     V_assembled_dip =[u[20] for u in u_q95],
                                     V_released_dip =[u[21] for u in u_q95]))

